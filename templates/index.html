<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" href="{{url_for('static',filename='normalize.css')}}">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="tooltip.css"/>
<script src="{{url_for('static', filename='d3.min.js')}}"></script>
<script src="{{url_for('static', filename='queue.min.js')}}"></script>
<script src="{{url_for('static', filename='topojson.v1.min.js')}}"></script>

<link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
<nav class="navbar navbar-default" id="navbar" style="height: 70px">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">
        <img alt="DEW" src="{{url_for('static', filename='data1.svg')}}" style="height: 40px"></a>
      <div style="margin-top: 10px;">
        <div style="display: table-cell; vertical-align: middle;">The Detailed Economic Window (DEW)</div>
        </div>
      </div>
      <div class="pull-right" style="margin-top: 10px">
      <ul class="nav nav-pills">
        <li class="active">
        <a href="{{ url_for('home')}}">National Map</a>
        <li><a href="{{ url_for('about')}}">About</a></li>
       </ul>
     </div>
     </div>
   </div>
</nav>

<div class="container">
  <div class="row">
    <div class="span12">
      <h2>Location Quotients across the country</h2>
      <p>Feel free to scroll around the country to find location quotients in your area!</p>
    </div>
  </div>
</div>

</div>
<div class="container">
  <div class="row">
    <div class="span12">
      <svg id="map" style="margin: 0 auto"></svg>
      		<select id="selectPer" class="select">
			<option value="Total">Total</option>
			<option value="PerCap">per Capita</option>
		</select>
    <form id="totalCap">
		<select id="selectType" class="select">
			<option value="lq_11">Agriculture, forestry, fishing and hunting</option>
			<option value="lq_21">Mining, quarrying, and oil and gas extraction</option>
			<option value="lq_22">Utilities</option>
			<option value="lq_23">Construction</option>
			<option value="lq_42">Wholesale trade</option>
			<option value="lq_51">Information</option>
			<option value="lq_52">Finance and insurance</option>
			<option value="lq_53">Real estate and rental and leasing</option>
			<option value="lq_54">Professional and technical services</option>
			<option value="lq_55">Management of companies and enterprises</option>
			<option value="lq_56">Administrative and waste servics</option>
			<option value="lq_61">Educational services</option>
			<option value="lq_62">Health care and social assistance</option>
			<option value="lq_71">Arts, entertainment and recreation</option>
			<option value="lq_72">Accomodation and food services</option>
			<option value="lq_81">Other services, expect public administration</option>
			<option value="lq_92">Public administration</option>
		</select>			
	</form>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="span12">
      <h2>How to understand the Location Quotient</h2>
          <p>Purr for no reason sun bathe, but vommit food and eat it again so intrigued by the shower see owner, run in terror cat snacks. Sleep nap hide when guests come over always hungry. Cat snacks meow all night having their mate disturbing sleeping humans. Meow all night having their mate disturbing sleeping humans bathe private parts with tongue then lick owner's face but stand in front of the computer screen. Sleep on keyboard. Hate dog lick arm hair and sit in box need to chase tail, yet chase laser or find empty spot in cupboard and sleep all day. Leave fur on owners clothes.</p>
          <h3>Frequently Asked Questions</h3>
        </div>
      </div>
    </div>


<footer>
  <div class="container">
<div id = 'links'>
	<a href = "https://github.com/DistrictDataLabs/02-group-b">National Map</a> &#124;
	<a href = "http://www.districtdatalabs.com/">District Data Labs</a> &#124; 
	<a href = "https://github.com">About</a>
</div>
  </div>
</footer>
</body>
<script>
var width = 800,
	height = 500;
var statById = d3.map();
var colorRange = [	
          'rgb(255,255,217)',
					'rgb(237,248,177)',
					'rgb(199,233,180)',
					'rgb(127,205,187',
					'rgb(65,182,196)',
					'rgb(29,145,192)',
					'rgb(34,94,168)',
					'rgb(37,52,148)',
					'rgb(8,29,88)'];
var quantile = d3.scale.quantile()
		.range(colorRange);
var path = d3.geo.path();
var svg = d3.select("#map")
		.attr("width", width)
		.attr("height", height)  
	.append('svg:g')
    	.call(d3.behavior.zoom().on("zoom", redraw))
  	.append('svg:g');
svg.attr("transform", "scale( " + .9 + ")");
function redraw() {
  console.log("here", d3.event.translate, d3.event.scale);
  svg.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}
d3.select("#selectPer")
		.on("change", function(){menuChange();});
d3.select("#selectType")
		.on("change", function(){menuChange();});
var tooltip = d3.select("body").append("div")
  	  .attr("class", "tooltip")
  	  .style("opacity", 1e-6)
  	  .style("background", "rgba(250,250,250,.7)");
tooltip.append("span").attr("id", "countyName")
queue()
	.defer(d3.json, "us.json")    
	.defer(d3.csv, "mvpfinal020715.csv")
	.defer(d3.json, "countyPop.json")
	.await(ready);
errorArray = [];
var counties;
var countyPop;
function ready(error, us, countiesJSON, countyPopJSON) {
	counties = countiesJSON;
	countyPop = countyPopJSON;
	counties.forEach(function(d){
		try{
			d.lq_11 = +d['lq_11'];
			d.lq_11 = +d['lq_21'];
 			d.lq_11 = +d['lq_22'];
			d.lq_11 = +d['lq_23'];
			d.lq_11 = +d['lq_42'];
			d.lq_11 = +d['lq_51'];
			d.lq_11 = +d['lq_52'];
			d.lq_11 = +d['lq_53'];
      d.lq_11 = +d['lq_55'];
			d.lq_11 = +d['lq_56'];
			d.lq_11 = +d['lq_61'];
			d.lq_11 = +d['lq_62'];
      d.lq_11 = +d['lq_71'];
			d.lq_11 = +d['lq_72'];
			d.lq_11 = +d['lq_81'];
			d.lq_11 = +d['lq_92'];

			statById.set(+d.fips, d);
			if (isNaN(d.lq_11)){
			}
		}
		catch(e){
			//remove double lines of csv
		}
	});
	quantile.domain(counties.map(function(d){return d.subPerCap;}));
	countyShapes = svg.append("g")
			.attr("class", "counties")
		.selectAll("path")
			.data(topojson.feature(us, us.objects.counties).features)
		.enter().append("path")
		countyShapes			
			.attr("fill", "rgb(200,200,200)")
			.attr("d", path)
					.on("mouseover", function(d){
						d3.select(this)
							.attr("stroke", "red")
							.attr("stroke-width", 1)
						tooltip
						    .style("left", (d3.event.pageX + 5) + "px")
						    .style("top", (d3.event.pageY - 5) + "px")
						    .transition().duration(300)
						    .style("opacity", 1)
						    .style("display", "block")
						updateDetails(statById.get(d.id));
				})
					.on("mouseout", function(d){
						d3.select(this)
							.attr("stroke", "")							
							.attr("stroke-width", .2)
						tooltip.transition().duration(700).style("opacity", 0);
			});
	svg.append("path")
			.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
			.attr("class", "states")
			.attr("d", path);
	menuChange();
}
var printDetails = [
					{'var': 'Submissions', 'print': 'Submissions'},
					{'var': 'totalMatches', 'print': 'Matches'},
					{'var': 'none', 'print': ''},
					{'var': 'Felony Returns', 'print': 'Felony Returns'},
					{'var': 'Convicted Criminals L1', 'print': 'Misdemeanor Returns'},
					{'var': 'No Criminal Conviction Return', 'print': 'Paperwork Returns'},
					{'var': 'none', 'print': ''},
					{'var': 'population', 'print': 'Population'},
					{'var': 'Activation Date', 'print': 'Start Date'}];
function updateDetails(county){
	tooltip.selectAll("div").remove();
	tooltip.selectAll("div").data(printDetails).enter()
		.append("div")
			.append('span')
				.text(function(d){return (d.print.length > 0) ? d.print + ": " : " - ";})				
				.attr("class", "boldDetail")
			.insert('span')
				.text(function(d){
					if (d.var != 'none'){
						return (""+county[d.var]).indexOf('/') == -1 ? totalFormat(county[d.var]) : county[d.var];
					}})
				.attr("class", "normalDetail");
	d3.select("#countyName").text(county.County);
}
var totalFormat = d3.format(",");
function menuChange(){
	var selectPer = document.getElementById('selectPer');
	selectPerValue = selectPer.options[selectPer.selectedIndex].value; 
	var selectType = document.getElementById('selectType');
	selectTypeValue = selectType.options[selectType.selectedIndex].value; 
	var keyName = selectTypeValue + (selectPerValue == 'PerCap' ? 'PerCap' : '');
	console.log(keyName);
	updateMap(keyName);
	console.log(d3.sum(counties, function(d){return d[selectTypeValue];}));
	var num = d3.sum(counties, function(d){return d[selectTypeValue];});
	d3.select("#magicNum")
		.text(selectPerValue == 'PerCap' ? d3.round(num*10000/313000000, 3) + " per 100,000" : totalFormat(num));
}
function updateMap(key){
	quantile.domain(counties.map(function(d){return d[key];}));
	countyShapes
		.transition().duration(1000).ease(d3.ease('linear'))
		.attr("fill", function(d) { 
			if (statById.get(d.id)){
				if(statById.get(d.id)[key] == 0){
					return 'white';
				}
				else{
					return quantile(statById.get(d.id)[key]);
				}
			}
			else{
				errorArray.push(d.id);
				return "white";
		}});
}
</script>
