<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" href="{{url_for('static',filename='normalize.css')}}">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="tooltip.css"/>
<script src="{{url_for('static', filename='d3.min.js')}}"></script>
<script src="{{url_for('static', filename='queue.min.js')}}"></script>
<script src="{{url_for('static', filename='topojson.v1.min.js')}}"></script>

<link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
<nav class="navbar navbar-default" id="navbar" style="height: 70px">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">
        <img alt="DEW" src="{{url_for('static', filename='data1.svg')}}" style="height: 40px"></a>
      <div style="margin-top: 10px;">
        <div style="display: table-cell; vertical-align: middle;">The Detailed Economic Window (DEW)</div>
        </div>
      </div>
      <div class="pull-right" style="margin-top: 10px">
      <ul class="nav nav-pills">
        <li class="active">
        <a href="{{ url_for('home')}}">National Map</a>
        <li><a href="{{ url_for('about')}}">About</a></li>
       </ul>
     </div>
     </div>
   </div>
</nav>

<div class="container">
  <div class="row">
    <div class="span12">
      <h2>Industry concentrations across the country</h2>
      <p>Scroll around the country and find location quotients in your area.</p>
    </div>
  </div>
</div>

</div>
<div class="container">
  <div class="row">
    <div class="span12">
      <svg id="map" style="margin: 0 auto"></svg>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
     <div class="span8">
      		<select id="selectPer" class="select">
			<option value="Total">Total</option>
		</select>
    <form id="totalCap">
		<select id="selectType" class="select">
      <!-- <option value="lq_11">Agriculture, forestry, fishing and hunting</option> -->
			<option value="lq_21">Mining, quarrying, and oil and gas extraction</option>
      <!-- <option value="lq_22">Utilities</option> -->
			<option value="lq_23">Construction</option>
      <!-- <option value="lq_42">Wholesale trade</option> -->
			<option value="lq_51">Information</option>
			<option value="lq_52">Finance and insurance</option>
      <!-- <option value="lq_53">Real estate and rental and leasing</option> -->
      <!-- <option value="lq_54">Professional and technical services</option> -->
      <!-- <option value="lq_55">Management of companies and enterprises</option> -->
      <!-- <option value="lq_56">Administrative and waste servics</option> -->
			<option value="lq_61">Educational services</option>
			<option value="lq_62">Health care and social assistance</option>
			<option value="lq_71">Arts, entertainment and recreation</option>
      <!-- <option value="lq_72">Accomodation and food services</option> -->
      <!-- <option value="lq_81">Other services, expect public administration</option> -->
      <!-- <option value="lq_92">Public administration</option> -->
		</select>			
	</form>
    <p><em>Find out more about each industry in the 'industry description' section below.</em></p>
    </div>
  </div>
</div>


<div class="container">
  <div class="row">
    <div class="span12">
      <h2>Understanding the Location Quotient</h2>
      <p>
The location quotient (LQ) is a way of quantifying the concentration of a particular industry, occupation, or demographic group in a region as compared to a larger area (i.e. nation or state) as a whole. It is an index frequently used in geography and economics to measure the relative concentration of activities, and is critical to understanding an area's economic strengths and weaknesses. It can reveal what makes a particular region “unique” in comparison to the national average. Specifically LQs can help identify emerging export industries beginning to bring money into the region, as well as endangered export industries that could erode the region’s economic base.</p>
<p>Location Quotients are determined by a formula similar to the one below.</p>

<p><strong>Location Quotient = (% of local employment in sector X) / (% of regional employment in sector X)</strong></p>

<p>A LQ greater than 1 signifies that an industry’s concentration in a local region is larger than the national concentration. A LQ less than or equal to 1 signifies than an industry’s concentration in a local region is less than the national concentration and may not have a great effect on the economic landscape as a whole. Meanwhile an LQ significantly greater than 1 is expected to indicate an industry that has the potential to be classified as an exporter.</p>

<p>As previously mentioned, the LQ is used identify export/import industries based on certain assumptions; such as the idea that local consumption and labor productivity are uniform across all regions. Based on this assumption, if an industry’s local presence exceeds its national share then local production is said to exceed local demand. Thus, a portion of local employment in that industry is assumed to be export. If the local presence is less than or equal to the national, then it is assumed that local production serves only local demand.
      </p>
         <h3>Industry Descriptions</h3>
          <ul>
            <li><img alt="Mining" src="{{url_for('static', filename='mining.svg')}}" style="height: 40px"></a><strong>Mining, Quarrying, and Oil</strong>
          <p>
          The Mining, Quarrying, and Oil and Gas Extraction sector comprises establishments that extract naturally occurring mineral solids, such as coal and ores; liquid minerals, such as crude petroleum; and gases, such as natural gas. The term mining is used in the broad sense to include quarrying, well operations, beneficiating, and other preparation customarily performed at the mine site.</p>
          <p>
A mine that manufactures a small amount of finished products will be classified in Sector 21, Mining, Quarrying, and Oil and Gas Extraction. An establishment that mines whose primary output is a more finished manufactured product will be classified in Sector 31-33, Manufacturing.
</p>
</li>

            <li><img alt="Construction" src="{{url_for('static', filename='construction.svg')}}" style="height: 40px"></a><strong>Construction</strong>
          <p>
          The Construction sector comprises establishments primarily engaged in the construction of buildings or engineering projects (e.g., highways and utility systems). Establishments primarily engaged in the preparation of sites for new construction and establishments primarily engaged in subdividing land for sale as building sites also are included in this sector.</p>
          <p>
Activities not included in this sector are: The installation and the ongoing repair and maintenance of telecommunications and utility networks is excluded from construction when the establishments performing the work are not independent contractors.As well as construction work performed by an enterprise primarily engaged in some business other than construction for its own account, using employees of the enterprise.
</p>
</li>
            <li><img alt="Information" src="{{url_for('static', filename='information.svg')}}" style="height: 40px"></a>
<strong>Information</strong>
<p>
The Information sector comprises establishments engaged in the following processes: (a) producing and distributing information and cultural products, (b) providing the means to transmit or distribute these products as well as data or communications, and (c) processing data.</p>
<p>
The main components of this sector are the publishing industries, including software publishing, and both traditional publishing and publishing exclusively on the Internet; the motion picture and sound recording industries; the broadcasting industries, including traditional broadcasting and those broadcasting exclusively over the Internet; the telecommunications industries; Web search portals, data processing industries, and the information services industries.</p>
</li>
            <li><img alt="Finance" src="{{url_for('static', filename='finance.svg')}}" style="height: 40px"></a>
<strong>Finance and insurance</strong>
<p>
The Finance and Insurance sector comprises establishments primarily engaged in financial transactions (transactions involving the creation, liquidation, or change in ownership of financial assets) and/or in facilitating financial transactions.</p>
</li>
            <li><img alt="Finance" src="{{url_for('static', filename='education.svg')}}" style="height: 40px"></a>
<strong>Educational services</strong>
<p>
This instruction and training is provided by specialized establishments, such as schools, colleges, universities, and training centers. These establishments may be privately owned and operated for profit or not for profit, or they may be publicly owned and operated.
</p>
</li>

            <li><img alt="Finance" src="{{url_for('static', filename='healthcare.svg')}}" style="height: 40px"></a>
<strong>Healthcare</strong>
<p>
The Health Care and Social Assistance sector comprises establishments providing health care and social assistance for individuals.

Excluded from this sector are aerobic classes, and nonmedical diet and weight reducing centers.</p>
</li>

            <li><img alt="Finance" src="{{url_for('static', filename='arts.svg')}}" style="height: 40px"></a>
<strong>Arts, entertainment, and recreation</strong>
<p>
This sector comprises (1) establishments that are involved in producing, promoting, or participating in live performances, events, or exhibits intended for public viewing; (2) establishments that preserve and exhibit objects and sites of historical, cultural, or educational interest; and (3) establishments that operate facilities or provide services that enable patrons to participate in recreational activities or pursue amusement.</p>
<p>
Excluded from this sector are: (1) establishments that provide both accommodations and recreational facilities, such as hunting and fishing camps and resort and casino hotels (2) restaurants and night clubs that provide live entertainment in addition to the sale of food  (3) motion picture theaters, libraries and archives, and publishers of newspapers, books, and computer software etc (4) establishments using transportation equipment to provide recreational and entertainment services. 
</p>
</li>





        </div>
      </div>
    </div>


<footer>
  <div class="container">
<div id = 'links'>
	<a href = "https://github.com/DistrictDataLabs/02-group-b">National Map</a> &#124;
	<a href = "http://www.districtdatalabs.com/">District Data Labs</a> &#124; 
	<a href = "https://github.com">About</a>
</div>
  </div>
</footer>
</body>
<script>
var width = 800,
	height = 500;
var statById = d3.map();
var colorRange = [	
					'rgb(254,235,226)',
					'rgb(251,180,185)',
					'rgb(247,104,161',
					'rgb(197,27,138)',
					'rgb(122,1,119)'];
var quantile = d3.scale.quantize()
		.range(colorRange);

var path = d3.geo.path();
var svg = d3.select("#map")
		.attr("width", width)
		.attr("height", height)
	.append('svg:g')
    	.call(d3.behavior.zoom().on("zoom", redraw))
  	.append('svg:g');
svg.attr("transform", "scale( " + .9 + ")");
function redraw() {
  console.log("here", d3.event.translate, d3.event.scale);
  svg.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}
d3.select("#selectPer")
		.on("change", function(){menuChange();});
d3.select("#selectType")
		.on("change", function(){menuChange();});
var tooltip = d3.select("body").append("div")
  	  .attr("class", "tooltip")
  	  .style("opacity", 1e-6)
  	  .style("background", "rgba(250,250,250,.7)");
tooltip.append("span").attr("id", "countyName")
queue()
	.defer(d3.json, "us.json")
	.defer(d3.csv, "mvpfinal020715.csv")
	.defer(d3.json, "countyPop.json")
	.await(ready);
errorArray = [];
var counties;
var countyPop;
function ready(error, us, countiesJSON, countyPopJSON) {
	counties = countiesJSON;
	countyPop = countyPopJSON;
	counties.forEach(function(d){
		try{
			d.lq_11 = +d['lq_11'];
			d.lq_11 = +d['lq_21'];
 			d.lq_11 = +d['lq_22'];
			d.lq_11 = +d['lq_23'];
			d.lq_11 = +d['lq_42'];
			d.lq_11 = +d['lq_51'];
			d.lq_11 = +d['lq_52'];
			d.lq_11 = +d['lq_53'];
      d.lq_11 = +d['lq_55'];
			d.lq_11 = +d['lq_56'];
			d.lq_11 = +d['lq_61'];
			d.lq_11 = +d['lq_62'];
      d.lq_11 = +d['lq_71'];
			d.lq_11 = +d['lq_72'];
			d.lq_11 = +d['lq_81'];
			d.lq_11 = +d['lq_92'];

			statById.set(+d.fips, d);
			if (isNaN(d.lq_11)){
			}
		}
		catch(e){
			//remove double lines of csv
		}
	});
	quantile.domain(counties.map(function(d){return d.subPerCap;}));
	countyShapes = svg.append("g")
			.attr("class", "counties")
		.selectAll("path")
			.data(topojson.feature(us, us.objects.counties).features)
		.enter().append("path")
		countyShapes			
			.attr("fill", "rgb(200,200,200)")
			.attr("d", path)
					.on("mouseover", function(d){
						d3.select(this)
							.attr("stroke", "red")
							.attr("stroke-width", 1)
						tooltip
						    .style("left", (d3.event.pageX + 5) + "px")
						    .style("top", (d3.event.pageY - 5) + "px")
						    .transition().duration(300)
						    .style("opacity", 1)
						    .style("display", "block")
						updateDetails(statById.get(d.id));
				})
					.on("mouseout", function(d){
						d3.select(this)
							.attr("stroke", "")
							.attr("stroke-width", .2)
						tooltip.transition().duration(700).style("opacity", 0);
			});
	svg.append("path")
			.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
			.attr("class", "states")
			.attr("d", path);
	menuChange();
}
var printDetails = [
					{'var': 'fips', 'print': 'FIPS'},
					{'var': 'totalMatches', 'print': 'Matches'},
					{'var': 'none', 'print': ''},
					{'var': 'Felony Returns', 'print': 'Felony Returns'},
					{'var': 'Convicted Criminals L1', 'print': 'Misdemeanor Returns'},
					{'var': 'No Criminal Conviction Return', 'print': 'Paperwork Returns'},
					{'var': 'none', 'print': ''},
					{'var': 'population', 'print': 'Population'},
					{'var': 'Activation Date', 'print': 'Start Date'}];
function updateDetails(county){
	tooltip.selectAll("div").remove();
	tooltip.selectAll("div").data(printDetails).enter()
		.append("div")
			.append('span')
				.text(function(d){return (d.print.length > 0) ? d.print + ": " : " - ";})				
				.attr("class", "boldDetail")
			.insert('span')
				.text(function(d){
					if (d.var != 'none'){
						return (""+county[d.var]).indexOf('/') == -1 ? totalFormat(county[d.var]) : county[d.var];
					}})
				.attr("class", "normalDetail");
	d3.select("#countyName").text(county.County);
}
var totalFormat = d3.format(",");
function menuChange(){
	var selectPer = document.getElementById('selectPer');
	selectPerValue = selectPer.options[selectPer.selectedIndex].value; 
	var selectType = document.getElementById('selectType');
	selectTypeValue = selectType.options[selectType.selectedIndex].value; 
	var keyName = selectTypeValue + (selectPerValue == 'PerCap' ? 'PerCap' : '');
	console.log(keyName);
	updateMap(keyName);
	console.log(d3.sum(counties, function(d){return d[selectTypeValue];}));
	var num = d3.sum(counties, function(d){return d[selectTypeValue];});
	d3.select("#magicNum")
		.text(selectPerValue == 'PerCap' ? d3.round(num*10000/313000000, 3) + " per 100,000" : totalFormat(num));
}
function updateMap(key){
	quantile.domain(counties.map(function(d){return d[key];}));
	countyShapes
		.transition().duration(1000).ease(d3.ease('linear'))
		.attr("fill", function(d) { 
			if (statById.get(d.id)){
				if(statById.get(d.id)[key] == 0){
					return 'white';
				}
				else{
					return quantile(statById.get(d.id)[key]);
				}
			}
			else{
				errorArray.push(d.id);
				return "white";
		}});
}



var legend = svg.selectAll('g.legendEntry')
    .data(quantile.range())
    .enter()
    .append('g').attr('class', 'legendEntry');

legend
    .append('rect')
    .attr("x", width - 780)
    .attr("y", function(d, i) {
       return i * 20;
    })
   .attr("width", 10)
   .attr("height", 10)
   .style("stroke", "black")
   .style("stroke-width", 1)
   .style("fill", function(d){return d;}); 
       //the data objects are the fill colors

legend
    .append('text')
    .attr("x", width - 760) //leave 5 pixel space after the <rect>
    .attr("y", function(d, i) {
       return i * 20;
    })
    .attr("dy", "0.8em") //place text one line *below* the x,y point
    .text(function(d,i) {
        var extent = quantile.invertExtent(d);
        //extent will be a two-element array, format it however you want:
        var format = d3.format("0.2f");
        return format(+extent[0]) + " - " + format(+extent[1]);
    });
</script>
